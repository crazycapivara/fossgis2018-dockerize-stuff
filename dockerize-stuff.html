<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

        <link href="https://fonts.googleapis.com/css?family=Calligraffitti|Chelsea+Market|Open+Sans+Condensed:300|PT+Sans|Ubuntu:300|Vollkorn" rel="stylesheet">

		<title>dockerize stuff</title>

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/bender.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
                <!-- title -->
				<section>
                    <h1>Dockerize Stuff</h1>
                    <img src="images/docker-engine.png" height="400">
                    <h2>Postgis Swarm And More</h2>
                </section> <!-- title end -->
                <!-- docker and virtual machines -->
                <section>
                    <section data-markdown>
                        # Docker?
                    </section>
                    <section>
                        <h3>Operating System Level Virtualization</h3>
                        <image src="images/containers.png" height="500">
                    </section>
                    <section>
                        <h3>ItÂ´s written in GO</h3>
                        <pre><code data-trim class="bash">
# Spin up 100 nginx containers in less than 1 minute
time for i in $(seq 1 100); do
   docker run -d -P --name nginx_$i nginx:alpine
done

# time: 0m56.476s
                        </code></pre>
                    </section>
                    <section>
                        <h1>Virtual Machines?</h1>
                        <image src="images/docker-vs-vm_vm.png" width="400">
                    </section>
                    <section>
                        <image src="images/docker-vs-vm_docker.png" width="400">
                        <image src="images/docker-vs-vm_vm.png" width="400">
                    </section>
                </section> <!-- docker and virtual machines end -->
                <section data-markdown>
                    ## Yeah
                </section>
                <!-- Run single container -->
                <section>
                    <section>
                        <h1>Postgis in a box</h1>
                    </section>
				    <section>
				        <h2>Pull it</h2>
					    <pre><code data-trim class="bash">						
$ docker pull mdillon/postgis

Using default tag: latest
latest: Pulling from mdillon/postgis
974c2c350dc4: Downloading [========================>                          ] 22.46 MB/45.13 MB
...
					    </code></pre>
                    </section>
                    <section>
                        <h2>Run it</h2>
                        <pre><code data-trim class="bash">
$ docker run --name postgis \
     -e POSTGRES_PASSWORD=docker \
     -p 55432:5432 \
     -d mdillon/postgis

     d4fdb5c6b51b4463a3244ead0247640998bbcdb900f7ca6f2ce08206b5bfbc3a
                    </code></pre>
                    <pre><code data-trim class="yaml">
     CONTAINER_ID: d4fdb5c6b51b
     IMAGE: mdillon/postgis
     PORTS: 0.0.0.0:55432->5432/tcp
     NAME: postgis  
                        </code></pre>
                    </section>
                </section> <!-- Run single container end -->
                <!-- networks -->
                <section>
                    <section>
                        <h1>Networks in docker</h1>
                        <p>bridge, overlay, ...</p>
                    </section>
                    <section>
                        <h2>bridge</h2>
                        <p><i> ... are best when you need multiple containers to communicate on the same Docker host.</i></p>
                        <pre><code data-trim class="bash">
$ docker network create fossgis

$ docker run --name postgis --network fossgis -p 55432:5432 -d mdillon/postgis
$ docker run --name geoserver --network fossgis -p 58080:8080 -d kartoza/geoserver
                        </code></pre>
                    </section>
                    <section>
                        <pre><code data-trim class="bash">
$ docker network inspect fossgis | jq ".[].Containers"
                        </code></pre>
                        <pre><code data-trim class="json">
{
    "5c8b8cf8c7631c028694653e3d35f72d709ab6c9a3fb6b7e127de6993685d10d": {
        "Name": "geoserver",
        "EndpointID": "d63198bdab9b9edcf641ecedd2b21853af8c35e574b6e3347ce4fff42baa8163",
        "MacAddress": "02:42:ac:13:00:03",
        "IPv4Address": "172.19.0.3/16",
        "IPv6Address": ""
    },
   "e500639420b3f26781652105402bae57e759905514e0f81550450783da35ce61": {
        "Name": "postgis",
        "EndpointID": "c6fd0c7388182ade5e600fda374a4e8d220e26b88f66aebf59fb8c747ebd6b1f",
        "MacAddress": "02:42:ac:13:00:02",
        "IPv4Address": "172.19.0.2/16",
        "IPv6Address": ""
    }
}                                  
                        </code></pre>
                    </section>
                    <section>
                        <p>http://localhost:58080/geoserver</p>
                        <img src="images/geoserver-postgis.png" height="400">
                    </section>
                    <section>
                        <h2>overlay</h2>
                        <p><i>... are best when you need containers running on different Docker hosts to communicate,
                            or when multiple applications work together using swarm services.</i></p>
                            <pre><code data-trim class="bash">$ docker network create --driver overlay fossgis_swarm</code></pre>
                    </section>
                </section> <!-- networks end -->
                <!-- docker compose -->
                <section>
                    <section>
                        <h1>docker compose</h1>
                        <pre><code data-trim class="yaml">
version: "2"

services:
    postgis:
        image: mdillon/postgis
        ports:
            - "55432:5432"
        environment:
            - POSTGRES_PASSWORD=docker
    geoserver:
        image: kartoza/geoserver
        ports:
            - "58080:8080"
                        </code></pre>
                    </section>
                    <section>
                        <h2>Run services</h2>
                        <pre><code data-trim class="bash">
$ cd docker
$ docker-compose up -d

Creating network "docker_default" with the default driver
Creating docker_postgis_1
Creating docker_geoserver_1
                        </code></pre>
                    </section>
                </section> <!-- docker compose -->
                <!-- docker swarm -->
                <section>
                    <section>
                        <h1>Orchestration</h1>
                        <ul>
                            <li><a href="https://docker.com">Docker Swarm</a></li>
                            <li><a href="https://kubernetes.io">Kubernetes</a></li>
                            <li><a href="http://rancher.com">Rancher</a></li>
                        </ul>
                    </section>
                    <section>
                        <h2>Docker Swarm</h2>
                        <p>Since Docker Version 1.12</p>
                        <img src="images/docker-swarm-logo.png" height="300">
                        <p>Managers & Workers</p>
                    </section>
                    <section>
                        <h2>Manager</h2>
                        <img src="images/zoidberg-swarm.png" height="300">
                        <pre><code data-trim class="bash"># Create a manager
$ docker swarm init --advertise-addr 192.168.99.100

# Generate the token needed to join the manager
$ docker swarm join-token worker</code></pre>
                    </section>
                    <section>
                        <h2>Workers</h2>
                        <img src="images/pi_swarm.jpg">
                        <pre><code data-trim class="bash"># Join the manager
docker swarm join --token [...] 192.168.99.100:2377</code></pre>
                    </section>
                    <section>
                        <h2>Deploy a service</h2>
                        <pre><code data-trim class="bash">$ docker service create \
   --replicas 2 \
   --name helloworld \
   alpine ping docker.com</code></pre>
                    </section>
                </section> <!-- docker swarm end -->
                <!-- postgis cluster -->
                <section>
                    <section>
                        <h1>Postgis cluster</h1>
                    </section>
                    <section>
                        <h2>Swarm setup</h2>
                        <p>See slides to "Docker Swarm"</p>
                    </section>
                    <section>
                        <h2>Network setup</h2>
                        <p>Create an overlay network on the manager node</p>
                        <pre><code>$ docker network create --driver overlay postgis_swarm</code></pre>
                    </section>
                    <section>
                        <h2>Master setup</h2>
                        <p>Add label to worker1</p> 
                        <pre><code>$ docker node update --label-add type=master worker1</code></pre>
                    </section>
                    <section>
                        <h2>Run master service</h2>
                        <pre><code data-trim>
#!/bin/bash
MASTER_SERVICE_NAME="postgis-master"

docker service create \
   --publish "5432:5432" \
   --mount type=volume,src=$MASTER_SERVICE_NAME-volume,dst=/pgdata,volume-driver=local \
   --name $MASTER_SERVICE_NAME \
   --network postgis_swarm \
   --constraint 'node.labels.type == master' \
   --env PGHOST=/tmp \
   --env PG_USER=testuser \
   --env PG_MODE=primary \
   --env PG_PRIMARY_USER=master \
   --env PG_ROOT_PASSWORD=password \
   --env PG_PASSWORD=password \
   --env PG_DATABASE=userdb \
   --env PG_PRIMARY_PORT=5432 \
   --env PG_PRIMARY_PASSWORD=password \
   --env PGDATA_PATH_OVERRIDE=persistent \
   crunchydata/crunchy-postgres-gis:centos7-10.0-1.6.0                             
                        </code></pre>
                    </section>
                    <section>
                        <h3>Some header</h3>
                        <ul>
                            <li>--mount<br> type=volume,<br> src=$MASTER_SERVICE_NAME-volume,<br> dst=/pgdata,<br> volume-driver=local</li>
                            <li class="fragment">--network postgis_swarm</li>
                            <li class="fragment">--constraint 'node.labels.type == master'</li>
                            <li class="fragment">--env PG_MODE=primary</li>
                            <li class="fragment">--env PGDATA_PATH_OVERRIDE=persistent</li>
                        </ul>
                    </section>
                </section> <!-- postgis cluster end -->
			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>
			// More info about config & dependencies:
			// - https://github.com/hakimel/reveal.js#configuration
			// - https://github.com/hakimel/reveal.js#dependencies
			Reveal.initialize({
                slideNumber: true,
                help: true,
                transition: 'none',
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
				]
			});
		</script>
	</body>
</html>
